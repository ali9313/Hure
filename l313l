#!/bin/bash

set -e  # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£

_get_ziplink () {
    local regex
    regex='(https?)://github.com/.+/.+'
    if [[ $UPSTREAM_REPO == "ali9313" ]]; then
        echo "aHR0cHM6Ly9naXRodWIuY29tL2FsaTkzMTMvbGlvL2FyY2hpdmUvSHVSZS56aXA" | base64 -d
    elif [[ $UPSTREAM_REPO =~ $regex ]]; then
        if [[ $UPSTREAM_REPO_BRANCH ]]; then
            echo "${UPSTREAM_REPO}/archive/${UPSTREAM_REPO_BRANCH}.zip"
        else
            echo "${UPSTREAM_REPO}/archive/HuRe.zip"
        fi
    else
        echo "aHR0cHM6Ly9naXRodWIuY29tL2FsaTkzMTMvbGlvL2FyY2hpdmUvSHVSZS56aXA=" | base64 -d
    fi
}

_get_repolink () {
    local regex
    local rlink
    regex='(https?)://github.com/.+/.+'
    if [[ $UPSTREAM_REPO == "ali9313" ]]; then
        rlink=$(echo "aHR0cHM6Ly9naXRodWIuY29tL2FsaTkzMTMvYWxpLmdpdA==" | base64 -d)
    elif [[ $UPSTREAM_REPO =~ $regex ]]; then
        rlink=$(echo "${UPSTREAM_REPO}")
    else
        rlink=$(echo "aHR0cHM6Ly9naXRodWIuY29tL2plcHRob25pcS9qZXB0aG9uLmdpdA==" | base64 -d)
    fi
    echo "$rlink"
}

_run_python_code() {
    python3${pVer%.*} -c "$1"
}

_run_catpack_git() {
    _run_python_code 'from git import Repo
import sys
OFFICIAL_UPSTREAM_REPO = "https://github.com/ali9313/lio"
ACTIVE_BRANCH_NAME = "HuRe"
repo = Repo.init()
origin = repo.create_remote("temponame", OFFICIAL_UPSTREAM_REPO)
origin.fetch()
repo.create_head(ACTIVE_BRANCH_NAME, origin.refs[ACTIVE_BRANCH_NAME])
repo.heads[ACTIVE_BRANCH_NAME].checkout(True)'
}

_run_cat_git() {
    local repolink=$(_get_repolink)
    _run_python_code 'from git import Repo
import sys
OFFICIAL_UPSTREAM_REPO="'$repolink'"
ACTIVE_BRANCH_NAME = "'${UPSTREAM_REPO_BRANCH:-HuRe}'"
repo = Repo.init()
origin = repo.create_remote("temponame", OFFICIAL_UPSTREAM_REPO)
origin.fetch()
repo.create_head(ACTIVE_BRANCH_NAME, origin.refs[ACTIVE_BRANCH_NAME])
repo.heads[ACTIVE_BRANCH_NAME].checkout(True)'
}

_set_bot () {
    local zippath
    zippath="aliup.zip"
    
    echo "Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„Ø³ÙˆØ±Ø³..."
    wget -q $(_get_ziplink) -O "$zippath"
    
    echo "ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."
    CATPATH=$(zipinfo -1 "$zippath" | grep -v "/.")
    unzip -qq "$zippath"
    echo "ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº."
    
    echo "ÙŠØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ..."
    rm -rf "$zippath"
    sleep 5
    
    _run_catpack_git
    cd "$CATPATH"
    _run_cat_git
    python3 ../setup/updater.py ../requirements.txt requirements.txt
    chmod -R 755 bin
    
    echo "Ø¨Ø¯Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª êª–êª¶ğ“²..."
    python3 -m aliup
}

# ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø©
echo "UPSTREAM_REPO: $UPSTREAM_REPO"
echo "UPSTREAM_REPO_BRANCH: $UPSTREAM_REPO_BRANCH"

_set_bot
